<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Deutsche Mobile Tastatur</title>
  <base href="./" />
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body {
      margin: 0;
      padding: 0px 0px 0px 0px;
      background: transparent; /* Changed for transparency */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: #ffffff;
      overflow: hidden;
    }
    
    #keyboard {
      background: #1c1c1e;
      border-radius: 0px;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .hg-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
      gap: 4px;
    }
    
    .hg-row:last-child {
      margin-bottom: 0;
    }
    
    .hg-button {
      background: #323234;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      transition: all 0.1s ease;
      font-weight: 400;
      font-size: 18px;
      height: 46px;
      min-width: 32px;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      touch-action: manipulation;
      font-family: inherit;
    }
    
    .hg-button[data-skbtn="{shift}"],
    .hg-button[data-skbtn="{bksp}"] {
      background: #525254;
      flex: 1.5;
      font-size: 16px;
    }
    
    .hg-button[data-skbtn="{space}"] {
      flex: 5;
      background: #323234;
      font-size: 14px;
    }
    
    .hg-button[data-skbtn="123"],
    .hg-button[data-skbtn="ABC"],
    .hg-button[data-skbtn="{symbols}"],
    .hg-button[data-skbtn="{numbers}"] {
      background: #525254;
      flex: 1.5;
      font-size: 14px;
    }
    
    .hg-button[data-skbtn="return"] {
      background: #0066cc;
      flex: 1.5;
      font-size: 14px;
      color: #ffffff;
    }
    
    .hg-button:active {
      background: #404042;
      transform: scale(0.95);
    }
    
    .hg-button.hg-activeButton {
      background: #0066cc;
      color: #ffffff;
      box-shadow: 0 0 10px rgba(0, 102, 204, 0.3);
    }
    
    .hg-button[data-skbtn="{shift}"]:active,
    .hg-button[data-skbtn="{bksp}"]:active,
    .hg-button[data-skbtn="123"]:active,
    .hg-button[data-skbtn="ABC"]:active {
      background: #606062;
    }
    
    .hg-button[data-skbtn="return"]:active {
      background: #0077dd;
    }
    
    /* Umlaut popup styling */
    .umlaut-popup {
      position: fixed;
      background: #48484a;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 2000;
      display: flex;
      gap: 6px;
      border: 1px solid #5a5a5c;
      animation: popupAppear 0.15s ease-out;
      pointer-events: auto;
      outline: none;
    }
    
    .umlaut-popup::before {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #48484a;
    }
    
    .umlaut-option {
      background: #323234;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      width: 45px;
      height: 45px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.1s ease;
      touch-action: manipulation;
      outline: none;
      font-family: inherit;
    }
    
    .umlaut-option:hover,
    .umlaut-option.selected {
      background: #0066cc;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
    }
    
    .umlaut-option:active {
      transform: scale(1.05);
      background: #0077dd;
    }
    
    @keyframes popupAppear {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(10px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .hg-button {
        height: 42px;
        font-size: 16px;
        min-width: 28px;
      }
      
      .hg-row {
        gap: 3px;
        margin-bottom: 5px;
      }
    }
    
    @media (max-width: 360px) {
      .hg-button {
        height: 38px;
        font-size: 15px;
        min-width: 26px;
      }
      
      .hg-row {
        gap: 2px;
      }
    }
    #notification-bar {
      display: none;
      background-color: #d4a017;
      color: #000;
      text-align: center;
      padding: 4px;
      font-size: 14px;
      border-radius: 4px;
      margin: 0 4px 6px 4px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="notification-bar"></div>
  <div id="keyboard"></div>

  <script>
    let keyboardElement = document.getElementById('keyboard');
    let currentLayout = 'default';
    let shiftActive = false;
    let popupElement = null;
    let globalClickDisabled = false;
    
    // These will be populated by the dynamically loaded layout script
    let layouts = {};
    let umlautMappings = {};

    async function loadLayout(layoutName) {
      console.log(`Requesting layout module for '${layoutName}'...`);
      try {
        // Request the layout module directly from the main process.
        const layoutModule = await window.electronAPI.getKeyboardLayoutData(layoutName);

        if (!layoutModule || !layoutModule.keyboardLayouts || !layoutModule.umlautMappings) {
          throw new Error(`Invalid or incomplete layout module received for '${layoutName}'.`);
        }

        // Directly assign the data from the module.
        layouts = layoutModule.keyboardLayouts;
        umlautMappings = layoutModule.umlautMappings;

        console.log(`Layout module for '${layoutName}' loaded successfully.`);
        return Promise.resolve();
      } catch (error) {
        console.error(`Failed to load layout module for '${layoutName}':`, error);
        return Promise.reject(error);
      }
    }

    function createKeyboard() {
      console.log('[KB_DEBUG] 10. Inside createKeyboard()...');
      function renderKeyboard() {
        console.log(`[KB_DEBUG] 11. Rendering keyboard for layout: '${currentLayout}'`);
        keyboardElement.innerHTML = '';

        let layout = layouts[currentLayout];

        if (!layout) {
          console.warn(`[KB_DEBUG] Layout '${currentLayout}' not found. Attempting to find a fallback.`);
          const fallbackKeys = ['default', 'normal'];
          for (const key of fallbackKeys) {
            if (layouts[key]) {
              layout = layouts[key];
              console.log(`[KB_DEBUG] Using fallback layout: '${key}'`);
              break;
            }
          }
          if (!layout) {
            const firstKey = Object.keys(layouts)[0];
            if (firstKey) {
              layout = layouts[firstKey];
              console.log(`[KB_DEBUG] Using first available layout as fallback: '${firstKey}'`);
            }
          }
        }

        if (!layout) {
          console.error('[KB_DEBUG] No valid keyboard layout found in the loaded data after fallbacks.');
          throw new Error("No valid keyboard layout found in the loaded data.");
        }
        
        console.log(`[KB_DEBUG] 11a. Using layout with ${layout.length} rows.`);
        layout.forEach((row) => {
          const rowDiv = document.createElement('div');
          rowDiv.className = 'hg-row';
          
          row.forEach(key => {
            const button = document.createElement('button');
            button.className = 'hg-button';
            button.setAttribute('data-skbtn', key);
            
            // Display text with Unicode for special characters
            let displayText = key;
            if (key === '{shift}') displayText = '\u21E7';
            else if (key === '{bksp}') displayText = '\u232B';
            else if (key === '{space}') displayText = '';
            else if (key === 'return') displayText = '\u21B5';
            else if (key === '{symbols}') displayText = '#+=';
            else if (key === '{numbers}') displayText = '123';
            
            button.textContent = displayText;
            
            // Visual feedback for shift
            if (key === '{shift}' && shiftActive) {
              button.classList.add('hg-activeButton');
            }
            
            // Setup button events
            setupButtonEvents(button, key);
            
            rowDiv.appendChild(button);
          });
          
          keyboardElement.appendChild(rowDiv);
        });
        
        // Report height after rendering
        setTimeout(() => {
          reportKeyboardHeight();
        }, 50);
      }

      function setupButtonEvents(button, key) {
        // Long press handlers (only for letters that have umlauts)
        if (umlautMappings[key] && !key.startsWith('{')) {
          let longPressTimer = null;
          let longPressTriggered = false;
          
          button.onmousedown = function(e) {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
              longPressTriggered = true;
              showUmlautPopup(button, key);
              e.preventDefault();
              e.stopPropagation();
            }, 500);
          };
          
          button.onmouseup = function(e) {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            
            // If long press was triggered, check if mouse is over a umlaut option
            if (longPressTriggered && popupElement) {
              const elementUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
              const umlautOption = elementUnderMouse?.closest('.umlaut-option');
              if (umlautOption) {
                const selectedUmlaut = umlautOption.textContent;
                e.preventDefault();
                e.stopPropagation();
                sendKey(selectedUmlaut);
                hideUmlautPopup();
                longPressTriggered = false;
                return false;
              }
              
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
            
            if (longPressTriggered) {
              e.preventDefault();
              e.stopPropagation();
              longPressTriggered = false;
              return false;
            }
          };
          
          // Touch events
          button.ontouchstart = function(e) {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
              longPressTriggered = true;
              showUmlautPopup(button, key);
              e.preventDefault();
              e.stopPropagation();
            }, 500);
          };
          
          button.ontouchend = function(e) {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
            
            if (longPressTriggered && popupElement && e.changedTouches && e.changedTouches.length > 0) {
              const touch = e.changedTouches[0];
              const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
              const umlautOption = elementUnderTouch?.closest('.umlaut-option');
              if (umlautOption) {
                const selectedUmlaut = umlautOption.textContent;
                e.preventDefault();
                e.stopPropagation();
                sendKey(selectedUmlaut);
                hideUmlautPopup();
                longPressTriggered = false;
                return false;
              }
              
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
            
            if (longPressTriggered) {
              e.preventDefault();
              e.stopPropagation();
              longPressTriggered = false;
              return false;
            }
          };
          
          // Override the normal click when long press is active
          button.onclick = function(e) {
            if (longPressTriggered) {
              longPressTriggered = false;
              e.preventDefault();
              e.stopPropagation();
              return false;
            } else {
              handleKeyPress(key);
            }
          };
        } else {
          // Normal buttons without umlauts
          button.onclick = function(e) {
            handleKeyPress(key);
          };
        }
      }

      function handleKeyPress(key) {
        if (key === '{shift}') {
          shiftActive = !shiftActive;
          currentLayout = shiftActive ? 'shift' : 'default';
          renderKeyboard();
          sendKey('{shift}');
        }
        else if (key === '123') {
          currentLayout = 'numbers';
          shiftActive = false;
          renderKeyboard();
        }
        else if (key === 'ABC') {
          currentLayout = shiftActive ? 'shift' : 'default';
          renderKeyboard();
        }
        else if (key === '{symbols}') {
          currentLayout = 'symbols';
          renderKeyboard();
        }
        else if (key === '{numbers}') {
          currentLayout = 'numbers';
          renderKeyboard();
        }
        else if (key === 'return') {
          sendKey('{enter}');
        }
        else if (key === '{space}') {
          sendKey(' ');
        }
        else if (key === '{bksp}') {
          sendKey('{bksp}');
        }
        else {
          sendKey(key);
          
          // Auto-reset shift after character (mobile behavior)
          if (shiftActive && currentLayout === 'shift') {
            shiftActive = false;
            currentLayout = 'default';
            setTimeout(() => {
              renderKeyboard();
            }, 100);
          }
        }
      }

      // Initial render
      renderKeyboard();
      return { handleKeyPress, renderKeyboard };
    }

    function showUmlautPopup(button, character) {
      const umlauts = umlautMappings[character];
      if (!umlauts || umlauts.length === 0) return;
      
      hideUmlautPopup();
      
      popupElement = document.createElement('div');
      popupElement.className = 'umlaut-popup';
      
      umlauts.forEach(umlaut => {
        const option = document.createElement('button');
        option.className = 'umlaut-option';
        option.textContent = umlaut;
        option.setAttribute('data-umlaut', umlaut);
        
        option.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          sendKey(umlaut);
          hideUmlautPopup();
          return false;
        };
        
        option.onmousedown = function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          sendKey(umlaut);
          hideUmlautPopup();
          return false;
        };
        
        option.ontouchend = function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          sendKey(umlaut);
          hideUmlautPopup();
          return false;
        };
        
        popupElement.appendChild(option);
      });
      
      // Prevent popup itself from closing
      popupElement.onclick = function(e) {
        e.stopPropagation();
        return false;
      };
      
      // Position popup
      document.body.appendChild(popupElement);
      
      const buttonRect = button.getBoundingClientRect();
      const popupRect = popupElement.getBoundingClientRect();
      
      const left = buttonRect.left + (buttonRect.width / 2) - (popupRect.width / 2);
      const top = buttonRect.top - popupRect.height - 12;
      
      popupElement.style.left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8)) + 'px';
      popupElement.style.top = Math.max(8, top) + 'px';
      
      // Disable global click handler temporarily to prevent immediate closing
      globalClickDisabled = true;
      
      setTimeout(() => {
        globalClickDisabled = false;
      }, 200);
      
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    function hideUmlautPopup() {
      if (popupElement) {
        popupElement.remove();
        popupElement = null;
      }
      globalClickDisabled = false;
    }

    function sendKey(key) {
      if (window.api && window.api.sendKey) {
        try {
          window.api.sendKey(key);
        } catch (e) {
          console.error('Error sending key:', e);
        }
      }
    }

    function reportKeyboardHeight() {
      // Measure and report keyboard height to main process
      const keyboardEl = document.getElementById('keyboard');
      
      if (keyboardEl && window.api && window.api.reportKeyboardHeight) {
        // Force layout reflow
        keyboardEl.offsetHeight;
        
        // Get the pure element height
        const elementHeight = keyboardEl.offsetHeight;
        
        // Send the pure element height
        window.api.reportKeyboardHeight(elementHeight);
      }
    }

    function resetKeyboardToDefault() {
      // Always reset to default layout when keyboard is shown
      currentLayout = 'default';
      shiftActive = false;
      console.log('Keyboard reset to default layout');
    }

    // Global event handlers for drag-and-drop support
    document.onmouseup = function(e) {
      if (popupElement) {
        const elementUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
        const umlautOption = elementUnderMouse?.closest('.umlaut-option');
        if (umlautOption) {
          const selectedUmlaut = umlautOption.textContent;
          e.preventDefault();
          e.stopPropagation();
          sendKey(selectedUmlaut);
          hideUmlautPopup();
          return false;
        }
      }
    };

    document.ontouchend = function(e) {
      if (popupElement && e.changedTouches && e.changedTouches.length > 0) {
        const touch = e.changedTouches[0];
        const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
        const umlautOption = elementUnderTouch?.closest('.umlaut-option');
        if (umlautOption) {
          const selectedUmlaut = umlautOption.textContent;
          e.preventDefault();
          e.stopPropagation();
          sendKey(selectedUmlaut);
          hideUmlautPopup();
          return false;
        }
      }
    };

    // Close popup when clicking outside
    document.onclick = function(e) {
      if (globalClickDisabled) return;
      
      if (popupElement) {
        const isPopupClick = e.target.closest('.umlaut-popup');
        const isUmlautOption = e.target.classList.contains('umlaut-option');
        
        if (!isPopupClick && !isUmlautOption) {
          hideUmlautPopup();
        }
      }
    };

    function showNotification(message, isError = false) {
      const bar = document.getElementById('notification-bar');
      if (bar) {
        bar.textContent = message;
        bar.style.backgroundColor = isError ? '#e53935' : '#d4a017';
        bar.style.color = '#ffffff';
        bar.style.display = 'block';
      }
    }

    // --- Initialization ---
    async function initializeKeyboard() {
      console.log('[KB_DEBUG] 1. Starting keyboard initialization...');
      let layoutName = 'de'; // Default layout
      try {
        console.log('[KB_DEBUG] 2. Fetching settings...');
        const settings = await window.electronAPI.getSettings();
        console.log('[KB_DEBUG] 3. Settings fetched:', settings);
        if (settings && settings.keyboardLayout) {
          layoutName = settings.keyboardLayout;
          console.log(`[KB_DEBUG] 4. Using layout from settings: '${layoutName}'`);
        } else {
          console.log(`[KB_DEBUG] 4. No layout in settings, using default: '${layoutName}'`);
        }
      } catch (e) {
        console.error("[KB_DEBUG] Error fetching settings, falling back to default layout.", e);
      }

      try {
        console.log(`[KB_DEBUG] 5. Attempting to load layout: '${layoutName}'`);
        // Convert to lowercase to ensure case-insensitive matching
        await loadLayout(layoutName.toLowerCase());
        console.log(`[KB_DEBUG] 8. Successfully loaded layout: '${layoutName}'`);
      } catch (error) {
        // If it fails, show a notification and try to load the default 'de' layout.
        console.error(`[KB_DEBUG] Error loading layout '${layoutName}', falling back to 'de'.`, error);
        showNotification(`Could not load layout '${layoutName}'. Using default.`);

        try {
          console.log(`[KB_DEBUG] 5a. Attempting to load fallback layout: 'de'`);
          await loadLayout('de');
          console.log(`[KB_DEBUG] 8a. Successfully loaded fallback layout: 'de'`);
        } catch (fallbackError) {
          // If the default layout ALSO fails, show a fatal error.
          console.error("[KB_DEBUG] FATAL: Could not load the default 'de' layout. Keyboard will not function.", fallbackError);
          showNotification("FATAL: Could not load default layout. Keyboard disabled.", true);
          return; // Stop execution.
        }
      }

      // This code now only runs AFTER a layout has been successfully loaded.
      try {
        console.log('[KB_DEBUG] 9. Creating keyboard instance...');
        const keyboardInstance = createKeyboard();
        console.log('[KB_DEBUG] 12. Keyboard instance created successfully.');

        // Global functions for main process to call
        window.updateKeyboardLayout = () => {
          if (keyboardInstance) keyboardInstance.renderKeyboard();
        };
        window.resetKeyboard = () => {
          resetKeyboardToDefault();
          if (keyboardInstance) keyboardInstance.renderKeyboard();
        };
        window.showKeyboard = () => {
          resetKeyboardToDefault();
          if (keyboardInstance) keyboardInstance.renderKeyboard();
          setTimeout(reportKeyboardHeight, 50);
        };

        // Report initial height and on resize
        setTimeout(() => reportKeyboardHeight(), 100);
        window.addEventListener('resize', () => setTimeout(reportKeyboardHeight, 100));
      } catch (renderError) {
        console.error("[KB_DEBUG] FATAL: Error creating or rendering keyboard.", renderError);
        showNotification(`FATAL: Error rendering keyboard: ${renderError.message}`, true);
      }
    }

    // Start the keyboard initialization
    initializeKeyboard();

    // Cleanup
    window.addEventListener('blur', hideUmlautPopup);
    window.addEventListener('resize', hideUmlautPopup);
  </script>
  <script>
      if (window.api) {
        window.api.on('update-keyboard-style', (style) => {
          const styleElement = document.getElementById('dynamic-keyboard-style') || document.createElement('style');
          styleElement.id = 'dynamic-keyboard-style';
          styleElement.innerHTML = `
            #keyboard {
              width: ${style.width}%;
              margin: 0 auto;
            }
            .hg-button {
              height: ${style.keyHeight}px;
            }
          `;
          document.head.appendChild(styleElement);

          // After applying style, wait a moment for DOM to update, then report height
          setTimeout(() => {
            reportKeyboardHeight();
          }, 50);
        });
      }
  </script>
</body>
</html>