<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AutodartsTouch Toolbar</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
<style>
html,body{margin:0;height:100%;background:transparent;font-family:'Open Sans',sans-serif}
#toolbar{
  position:fixed; top:0; left:0; right:0; height:72px;
  display:grid; grid-template-columns:auto 1fr auto;
  align-items:center; padding:0 12px; z-index:99999;
  background-image:
    radial-gradient(50% 30% at 86% 0%, #313370e3, #40348600),
    radial-gradient(50% 70% at 70% 22%, #26599ae6, #40348600),
    radial-gradient(50% 70% at 112% 44%, #2c436cd9, #40348600),
    radial-gradient(90% 90% at -12% 89%, #0f2f50e0, #40348600),
    radial-gradient(50% 70% at -2% 53%, #34205fe3, #40348600),
    radial-gradient(50% 70% at 36% 22%, #403486d4, #40348600),
    radial-gradient(50% 40% at 66% 59%, #206fb9de 7%, #206fb900),
    radial-gradient(75% 75% at 50% 50%, #3662b9 1%, #2d285b);
  background-repeat:no-repeat;background-size:cover;
}
button{font-family:'Open Sans',sans-serif;font-size:20px;padding:0 12px;border:none;background:none;color:#fff;cursor:pointer}
button:hover{color:#e0e0e0}
#tabs{display:flex;justify-content:space-evenly;gap:16px;align-items:center;height:100%}
.sidebtn{
    width:40px;height:56px;background:transparent;color:#fff;font-size:24px;border:none;padding:0;
    display: flex; align-items: center; justify-content: center;
}
button[aria-selected="true"]::after{content:"";display:block;margin:2px auto 0 auto;width:66%;height:2px;background:#fff;border-radius:1px}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
@keyframes marquee {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
#update-notification {
  position: absolute;
  right: 180px;
  top: 50%;
  transform: translateY(-50%);
  max-width: 220px;
  display: none; /* Changed to 'flex' by JS */
  flex-direction: row;
  align-items: center;
  background-color: #f0ad4e;
  color: #000;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 14px;
  z-index: 10;
}
#update-notification p {
  flex-grow: 1;
  overflow: hidden;
  white-space: nowrap;
  margin: 0;
  padding: 0;
}
#update-notification p span {
  display: inline-block;
  font-weight: bold;
  animation: marquee 15s linear infinite;
}
#close-update-notification {
  background: none;
  border: none;
  color: #000;
  font-size: 20px;
  cursor: pointer;
  padding: 0 0 0 8px; /* Space between text and button */
  line-height: 1;
  flex-shrink: 0;
}
</style>
</head>
<body>
  <div id="toolbar" role="toolbar" aria-label="AutodartsTouch Controls">
    <div style="display:flex;align-items:center;justify-content:center;height:100%;gap:8px;">
      <button class="sidebtn" id="webVKBtn" aria-label="Web Keyboard">&#x2328;</button>
      <button class="sidebtn" id="refreshBtn" aria-label="Refresh">&#x27F3;</button>
    </div>

    <div id="tabs" role="tablist" aria-label="Pages">
      <!-- Tabs will be dynamically inserted here -->
    </div>

    <div style="display:flex;align-items:center;justify-content:center;height:100%;gap:8px;">
      <div id="update-notification">
        <p><span>Update available!</span></p>
        <button id="close-update-notification" aria-label="Dismiss update notification">&times;</button>
      </div>
      <button class="sidebtn" id="settingsBtn" aria-label="Settings">&#x2699;</button>
      <button class="sidebtn" id="powerBtn" aria-label="Power">
        <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="#FFFFFF">
          <path d="M0 0h24v24H0V0z" fill="none"/>
          <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/>
        </svg>
      </button>
    </div>
  </div>

<script>
  let tabButtons = [];
  let notifications = []; // { type: 'app' | 'extension', message: '...' }

  async function updateActiveTab() {
    if (!window.api || !window.api.getCurrentView) return;
    const activeViewId = await window.api.getCurrentView();
    tabButtons.forEach(t => {
      t.setAttribute('aria-selected', t.id === activeViewId ? 'true' : 'false');
    });
  }

  function switchTab(tabId) {
    if (window.api && window.api.switchTab) {
      window.api.switchTab(tabId);
    }
  }

  async function generateTabs() {
    const tabsContainer = document.getElementById('tabs');
    if (window.api && window.api.getTabs) {
      const tabs = await window.api.getTabs();
      tabs.forEach((tab, index) => {
        if (tab.url) {
          const button = document.createElement('button');
          const tabId = `tab${index}`;
          button.id = tabId;
          button.textContent = tab.name || `Tab ${index + 1}`;
          button.setAttribute('role', 'tab');
          button.setAttribute('aria-selected', 'false');
          button.onclick = () => switchTab(tabId);
          tabsContainer.appendChild(button);
          tabButtons.push(button);
        }
      });
      updateActiveTab();
    }
  }

  function renderNotifications() {
    const notificationContainer = document.getElementById('update-notification');
    const notificationText = notificationContainer.querySelector('p span');
    const separator = '&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;';

    if (notifications.length > 0) {
      const allMessages = notifications.map(n => n.message).join(separator);
      // Duplicate the full string for a seamless loop
      notificationText.innerHTML = allMessages + separator + allMessages;
      notificationContainer.style.display = 'flex';
    } else {
      notificationContainer.style.display = 'none';
      notificationText.innerHTML = '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    generateTabs();

    if (window.api && window.api.send) {
      window.api.send('toolbar-ready');
    }

    if (window.api && window.api.on) {
      window.api.on('active-view-changed', (activeViewId) => {
        updateActiveTab();
      });

      // Message is an object: { type: 'app' | 'extension', message: '...' }
      window.api.on('update-available', (updateInfo) => {
        // Avoid duplicate notifications
        if (!notifications.some(n => n.type === updateInfo.type)) {
          notifications.push(updateInfo);
          renderNotifications();
        }
      });

      // Hide all notifications if one is installed, as the app will check again on restart.
      // Or, if payload is provided, remove the specific one.
      window.api.on('update-installed', (payload) => {
          if (payload && payload.type) {
              notifications = notifications.filter(n => n.type !== payload.type);
          } else {
              // Fallback for old messages without a payload
              notifications = [];
          }
          renderNotifications();
      });

      window.api.on('update-toolbar-style', ({ height, fontSize }) => {
        const toolbar = document.getElementById('toolbar');
        if (toolbar) toolbar.style.height = `${height}px`;

        const buttons = document.querySelectorAll('#toolbar button');
        buttons.forEach(button => button.style.fontSize = `${fontSize}px`);

        const powerIcon = document.querySelector('#powerBtn svg');
        if (powerIcon) {
          const iconSize = Math.round(fontSize * 1.15);
          powerIcon.setAttribute('height', `${iconSize}px`);
          powerIcon.setAttribute('width', `${iconSize}px`);
        }
      });
    }

    document.getElementById('webVKBtn').addEventListener('pointerdown', (e) => { e.preventDefault(); if (window.api && window.api.toggleWebKeyboard) window.api.toggleWebKeyboard(); });
    document.getElementById('webVKBtn').addEventListener('click', (e) => e.preventDefault());

    document.getElementById('close-update-notification').addEventListener('click', () => {
        notifications = []; // Clear all notifications
        renderNotifications();
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
        if (window.api && window.api.openSettings) window.api.openSettings();
    });

    const refreshBtn = document.getElementById('refreshBtn');
    let pressTimer = null;
    refreshBtn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        pressTimer = window.setTimeout(() => { if (window.api && window.api.forceReload) window.api.forceReload(); pressTimer = null; }, 800);
    });
    refreshBtn.addEventListener('pointerup', (e) => {
        e.preventDefault();
        if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; if (window.api && window.api.refresh) window.api.refresh(); }
    });
    refreshBtn.addEventListener('pointerleave', () => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } });

    document.getElementById('powerBtn').addEventListener('click', () => {
        if (window.api && window.api.openPowerMenu) window.api.openPowerMenu();
    });
  });
</script>
</body>
</html>